#!/usr/bin/env ruby

raise 'Run it with "bin/rails runner", not on its own' unless Object.constants.include?(:Rails)

file = ARGV.fetch(0)

CSV.open(file, 'wb') do |csv|
  csv.add_row([
                '',
                '',
                'Earliest release',
                '',
                '',
                '',
                'OLD',
                '',
                '',
                'NEW',
                '',
              ])
  csv.add_row([
                'NOMS No',
                'Prison ID',
                'Date',
                'Type',
                'Sentence start date',
                'Handover start date',
                'Handover date',
                'Responsibility',
                'Handover start date',
                'Handover date',
                'Responsibility',
              ])
  Prison.all.each do |prison|
    offenders = prison.offenders

    offenders.each do |o|
      begin
        old = HandoverDateService.handover(o)
        new = HandoverDateService.handover_2(o)

        if old.attributes != new.attributes
          csv.add_row([
                        o.offender_no,
                        prison.code,
                        o.earliest_release_for_handover.date,
                        o.earliest_release_for_handover.name,
                        o.sentence_start_date,
                        old.start_date&.iso8601,
                        old.handover_date&.iso8601,
                        old.responsibility,
                        new.start_date&.iso8601,
                        new.handover_date&.iso8601,
                        new.responsibility
                      ])
        end
      end
    rescue
      warn "Error with #{o.offender_no}"
      raise
    end
  end
end
